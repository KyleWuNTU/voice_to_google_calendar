<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice to Google Calendar Event</title>
    <!-- Linking external CSS file from src folder -->
    <link rel="stylesheet" href="src/styles.css">
</head>
<body>
    <header>
        <button id="authorize-btn">Authorize with Google</button>
    </header>
    <main>
        <h1>Generate Google Calendar Event from Voice</h1>
        <div class="button-container">
            <button id="start-record-btn" disabled>Start Recording</button>
            <button id="stop-record-btn" disabled>Stop Recording</button>
        </div>
        <p id="status">Please authorize with Google to begin.</p>
    </main>
    <footer>
        <!-- Move logo to the footer, bottom left -->
        <div class="footer-content">
            <p>&copy; 2024 Voice to Calendar Event</p>
        </div>
    </footer>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        const authorizeBtn = document.getElementById('authorize-btn');
        const startRecordBtn = document.getElementById('start-record-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const statusDisplay = document.getElementById('status');

        // Open OAuth pop-up
        authorizeBtn.addEventListener('click', () => {
            const width = 600, height = 600;
            const left = (screen.width / 2) - (width / 2);
            const top = (screen.height / 2) - (height / 2);

            // Open a new window to start the OAuth flow
            const authWindow = window.open('/auth', 'GoogleAuth', `width=${width},height=${height},top=${top},left=${left}`);

            // Poll the window to detect when it is closed
            const authInterval = setInterval(() => {
                if (authWindow.closed) {
                    clearInterval(authInterval);
                    statusDisplay.textContent = 'Authorization completed, you can now start recording.';
                    startRecordBtn.disabled = false;  // Enable start recording button
                    authorizeBtn.disabled = true;  // Disable the authorize button
                }
            }, 1000);
        });

        // Start recording audio
        startRecordBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

                mediaRecorder.start();
                statusDisplay.textContent = "Recording...";
                startRecordBtn.disabled = true;
                stopRecordBtn.disabled = false;

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
            } catch (err) {
                console.error('Failed to start recording:', err);
                statusDisplay.textContent = "Failed to start recording, please check browser compatibility.";
            }
        });

        // Stop recording audio
        stopRecordBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            statusDisplay.textContent = "Recording stopped, uploading...";
            startRecordBtn.disabled = false;
            stopRecordBtn.disabled = true;

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                statusDisplay.textContent = "Recording saved, uploading...";

                try {
                    const response = await fetch('/upload-audio', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (response.ok) {
                        statusDisplay.textContent = `Event created: ${result.event.summary} at ${result.event.start.dateTime}`;
                        console.log('Event created successfully:', result.event);
                    } else {
                        statusDisplay.textContent = `Error: ${result.error}`;
                        console.error('Error:', result.error);
                    }
                } catch (error) {
                    statusDisplay.textContent = `Error: ${error.message}`;
                    console.error('Error:', error);
                }

                audioChunks = [];  // Clear audio data
            };
        });
    </script>
</body>
</html>
